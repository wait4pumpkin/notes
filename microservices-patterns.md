## 外部API模式

微服务架构下，每个服务都有各自的API

不同的客户端对API有不同的需求，需要决定（整体）应用对客户端开放哪种API

### 外部API的设计难题

客户端直接调用各个服务的缺点：

- 客户端需要发送多个请求，效率低，同时可能影响用户体验
- 客户端与各个服务强耦合
- 服务可能使用了客户端不适用的通信协议

不同客户端在这几个问题上的诉求

- 移动客户端：多次请求延时高，前端需实现API组合代码，复杂的API耗电高；客户端发布周期长，服务API难以更新；通常只能支持调用HTTP和WebSockets的服务
- Web应用：在防火墙内，带宽和延时都不是问题，也可以与服务同步更新，支持非Web友好的协议，总体来说，影响不大
- 浏览器中的JavaScript：可以与服务同步更新（因为脚本是服务端下发的），延时问题需要考虑
- 第三方应用：需要稳定的API，服务API不能随意变更

### API Gateway模式

#### 什么是API Gateway模式

看作是一种服务，从防火墙外部访问内部应用的唯一入口点

- 请求路由：根据路由映射，转发请求到相应服务
- API组合：不仅仅是反向代理
- 协议转换
- 为不同客户端提供专用API：定义不同的API模块，或使用后端前置，为每个客户端定义单独API Gateway
- 边缘功能：相比在后端实现，可以减少延时（更早进行鉴权），降低后端复杂性，分隔功能
  - 身份验证
  - 访问授权
  - 频率限制
  - 缓存
  - 请求日志
  - API调用的指标搜集



**整体架构**

分两层

- API层：不同客户端定义不同的API
- 公共层



**API Gateway的所有者模式**

- 单独团队开发运维，客户端要访问特定服务，必须等API Gateway团队公开API，集中式管理与微服务理念相悖
- （Netflix）客户端团队拥有其相关API模块的开发权限，API Gateway团队负责公共模块和运维，同时要求API Gateway能自动化部署（否则客户端团队需要等API Gateway团队部署）



**后端前置模式**

不同团队修改同一个API Gateway仓库，职责不明，且API模块在部署上会互相影响。

BFF，Backends for frontends，每个客户端都有一个独立的API Gateway，由相应团队管理。API Gateway团队只实现公共层的共享库，不负责运维。



#### API Gateway模式的好处和弊端

封装了应用内部结构，优化请求数，为不同客户端提供专有API

增加了开发、部署、管理的高可用组件，同时必须更新API Gateway才能对外提供服务



#### 以Netflix为例的API Gateway

- 刚开始使用万能API
- 适应端的多样性，使用API Gateway为不同设备提供专有API（Groovy脚本实现API）
- 使用后端前置，客户端团队使用Node.js写API模块，运行在Docker，但不直接调用服务，而是调用另一个API Gateway（Netflix Falcor公开服务API，可执行动态API组合）



#### API Gateway的设计难题

- 性能和可扩展性：同步 / 异步IO
- 



## 部署微服务应用

部署包含两个概念：流程和架构

生产环境必需实现的四个关键功能：

- 服务管理接口：创建、更新和配置服务；
- 运行时服务管理：确保始终运行所需的服务实例数
- 监控：包括日志和各种应用指标
- 请求路由

### 部署模式：编程语言特定的发布包格式

生产环境需要安装必要的运行时

同一台计算机可以部署一个或多个服务实例。服务实例可以是单个或一组进程。

服务实例可以是按进程隔离，也可以在单个进程是运行多个实例（如单个Tomcat上运行多个服务）

#### 使用编程语言特定的发布包格式进行部署的好处

- 快速部署
  - 要复制的包字节数少
  - 启动服务耗时短
- 高效的资源利用

#### 使用编程语言特定的发布包格式进行部署的弊端

- 缺乏对技术栈的封装：运维团队需要了解每个服务的具体细节（特定版本的运行时，包括语言和框架）
- 无法约束服务实例消耗的资源
- 在同一台计算机上运行多个服务实例时缺少隔离
- 很难自动判定防止服务实例的位置：缺少通用的自动编排

### 部署模式：将服务部署为虚拟机

假如使用AWS EC2，可以打包为AMI（Amazon Machine Image），并使用AWS Auto Scaling Group管理

创建AMI的工具：

- Netfilx的 [Aminator](https://github.com/Netflix/aminator) （已停止更新）
- [Packer](https://www.packer.io)，支持EC2、Digital Ocean、Virtual Box、VMware

AWS Elastic Beanstalk是更快捷的部署方式，只需上传应用，就可部署为支持负载均衡的多个EC2实例，支持多种语言的打包格式；不构建AMI，而是在基础镜像启动时安装应用；还可部署Docker容器，每个EC2运行一个或多个容器，但编排的单元时EC2实例而不是容器。

#### 将服务部署为虚拟机的好处

- 虚拟机镜像封装了技术栈
- 服务实例隔离
- 可使用成熟的云基础设施

#### 将服务部署为虚拟机的弊端

- 资源利用率低：每个实例是包括操作系统的完整虚拟机
- 部署速度相对慢：需要构建镜像，传输完整的镜像，从镜像构建虚拟机，系统启动
- 系统管理的额外开销：承担给操作系统和Runtime打补丁的责任

### 部署模式：将服务部署为容器

